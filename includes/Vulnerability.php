<?php

namespace NHRRob\Secure;

if (!defined('ABSPATH')) {
    exit;
}

/**
 * Vulnerability Checker Class
 */
class Vulnerability
{

    /**
     * API Base URL
     */
    const API_BASE_URL = 'https://www.wpvulnerability.com/api/';

    /**
     * Cache key
     */
    const CACHE_KEY = 'nhrrob_secure_vulnerability_results';

    /**
     * Initialize the class
     */
    public function __construct()
    {
        add_action('nhrrob_secure_vulnerability_scan_cron', [$this, 'run_scan']);
    }

    /**
     * Get scan results (cached)
     *
     * @return array
     */
    public function get_results()
    {
        $results = get_transient(self::CACHE_KEY);

        if (false === $results) {
            return $this->run_scan();
        }

        return $results;
    }

    /**
     * Run the vulnerability scan
     *
     * @return array
     */
    public function run_scan()
    {
        $results = [
            'core' => $this->check_core(),
            'plugins' => $this->check_plugins(),
            'themes' => $this->check_themes(),
            'last_scan' => time(),
        ];

        set_transient(self::CACHE_KEY, $results, DAY_IN_SECONDS);

        // If vulnerabilities found, send email notification
        if ($this->has_vulnerabilities($results)) {
            $this->send_notification($results);
        }

        return $results;
    }

    /**
     * Check if any vulnerabilities were found
     *
     * @param array $results
     * @return bool
     */
    private function has_vulnerabilities($results)
    {
        if (!empty($results['core']))
            return true;

        foreach ($results['plugins'] as $plugin) {
            if (!empty($plugin['vulnerabilities']))
                return true;
        }

        foreach ($results['themes'] as $theme) {
            if (!empty($theme['vulnerabilities']))
                return true;
        }

        return false;
    }

    /**
     * Check WP Core
     */
    private function check_core()
    {
        global $wp_version;
        $response = wp_remote_get(self::API_BASE_URL . 'core/' . $wp_version);

        if (is_wp_error($response))
            return [];

        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);

        return (isset($data['vulnerabilities'])) ? $data['vulnerabilities'] : [];
    }

    /**
     * Check Plugins
     */
    private function check_plugins()
    {
        if (!function_exists('get_plugins')) {
            require_once ABSPATH . 'wp-admin/includes/plugin.php';
        }

        $plugins = get_plugins();
        $vulnerable_plugins = [];

        foreach ($plugins as $plugin_path => $plugin_data) {
            $slug = dirname($plugin_path);
            if ('.' === $slug) {
                $slug = str_replace('.php', '', $plugin_path);
            }

            $response = wp_remote_get(self::API_BASE_URL . 'plugin/' . $slug);
            if (is_wp_error($response))
                continue;

            $body = wp_remote_retrieve_body($response);
            $data = json_decode($body, true);

            if (!empty($data['vulnerabilities'])) {
                $vulnerable_plugins[] = [
                    'name' => $plugin_data['Name'],
                    'version' => $plugin_data['Version'],
                    'vulnerabilities' => $data['vulnerabilities']
                ];
            }
        }

        return $vulnerable_plugins;
    }

    /**
     * Check Themes
     */
    private function check_themes()
    {
        $themes = wp_get_themes();
        $vulnerable_themes = [];

        foreach ($themes as $slug => $theme_data) {
            $response = wp_remote_get(self::API_BASE_URL . 'theme/' . $slug);
            if (is_wp_error($response))
                continue;

            $body = wp_remote_retrieve_body($response);
            $data = json_decode($body, true);

            if (!empty($data['vulnerabilities'])) {
                $vulnerable_themes[] = [
                    'name' => $theme_data->get('Name'),
                    'version' => $theme_data->get('Version'),
                    'vulnerabilities' => $data['vulnerabilities']
                ];
            }
        }

        return $vulnerable_themes;
    }

    /**
     * Send email notification
     */
    private function send_notification($results)
    {
        $to = get_option('admin_email');
        $subject = sprintf('[%s] Security Alert: Vulnerabilities Detected', get_bloginfo('name'));

        $message = "Vulnerabilities have been detected on your site.\n\n";

        if (!empty($results['core'])) {
            $message .= "WordPress Core:\n";
            foreach ($results['core'] as $v) {
                $message .= "- " . $v['name'] . "\n";
            }
            $message .= "\n";
        }

        if (!empty($results['plugins'])) {
            $message .= "Plugins:\n";
            foreach ($results['plugins'] as $plugin) {
                $message .= "- " . $plugin['name'] . " (" . $plugin['version'] . ")\n";
                foreach ($plugin['vulnerabilities'] as $v) {
                    $message .= "  * " . $v['name'] . "\n";
                }
            }
            $message .= "\n";
        }

        if (!empty($results['themes'])) {
            $message .= "Themes:\n";
            foreach ($results['themes'] as $theme) {
                $message .= "- " . $theme['name'] . " (" . $theme['version'] . ")\n";
                foreach ($theme['vulnerabilities'] as $v) {
                    $message .= "  * " . $v['name'] . "\n";
                }
            }
            $message .= "\n";
        }

        $message .= "\nPlease log in to your dashboard to take action: " . admin_url('tools.php?page=nhrrob-secure-settings');

        wp_mail($to, $subject, $message);
    }
}
